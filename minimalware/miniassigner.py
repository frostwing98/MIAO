from datetime import datetime
import queue
import re
import os
import json
import subprocess
import time
import pandas as pd
from multiprocessing.managers import BaseManager
import os.path
from os import path


def writeres(res,result_file_path):
    if res!={}:
        f=open(result_file_path,"a")
        f.write(json.dumps(res)+"\n")
        f.close()
def writescannedappid(wxid,scanned_appid_path):
    f=open(scanned_appid_path,'a')
    f.write(wxid+"\n")
    f.close()
index = 0
def loadscanned(scanned_appid_path):
    res=set()
    finalres=open(scanned_appid_path,"r")
    lastone=''
    for l in finalres:
        appid=l.replace('\n','')
        if appid!='':
            res.add(appid)
            lastone=appid
        # if not name in res:
        #     res.add(name.strip())
        
    print("scanned",len(res))
    return res,lastone



# main(
#    appidlist=["wxdeadbeef","",...], 
#    result_file_path="scanedoverallres.csv"
#    scanned_appid_path="scannedallminiapps.csv"
#    post_process: function(res) {return res})

def main(appidlist,result_file_path, scanned_appid_path,post_process):
    task_queue = queue.Queue()
    result_queue = queue.Queue()

    class QueueManager(BaseManager):
        pass

    QueueManager.register('get_task_queue', callable=lambda: task_queue)
    QueueManager.register('get_result_queue', callable=lambda: result_queue)
    manager = QueueManager(address=('127.0.0.1', 8989), authkey=b'abc')
    manager.start()
    task = manager.get_task_queue()
    result = manager.get_result_queue()
    print("App analyzer Master is running")
    total=0
    scanned,lastone=loadscanned(scanned_appid_path)
    flag=False
    total+=len(scanned)

    loadedcnt=0
    for appid in appidlist:            
        if lastone=='' or appid==lastone:
            flag=True
        
        
        if flag and appid not in scanned:
            # print("loading... {} ".format(total))
            loadedcnt+=1
            if loadedcnt%10000==0:
                print("loading... {} ".format(total))
            task.put(appid)
            total+=1
        else:
            print('skipped',appid)
            # total+=1
    print()
    print('hmm',total)


    count=len(scanned)
    # fwpage=open('scannedpages.csv','a')
    # fwurl=open('scannedurls.csv','a')
    fw=open('scannedjsons.csv','a')
    # receiving the result
    while(count < total):
        alldata = result.get(timeout=20000)
        json=alldata[1]
        # resurl=alldata[2]
        appid=alldata[0]

        # alldata=json.loads(resurl)
        # alldata=post_process(alldata)
        
        count += 1
        # print("loading... {} ".format(total),  end="\r", flush=True)
        print('scanned',appid)
        # print(resurl)
        fw.write(str(json)+"\n")
        # fwurl.write(resurl+"\n")
        # print(res,appid,'fucker')
        
        writescannedappid(appid,scanned_appid_path)
        # if alldata=={}:
        #     print('no result for ',appid)
        #     continue
        
        print("{}/{}".format(count, total))
        # writeres(alldata,result_file_path)
    manager.shutdown()

